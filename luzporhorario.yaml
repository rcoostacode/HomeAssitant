blueprint:
  name: Luz com Horário
  description: >
    Automação completa com horário, presença opcional e luminosidade opcional.
    - Liga no horário inicial (com ou sem lux)
    - Desliga no horário final
    - Fora do horário liga por presença (se existir sensor)
    - Após pôr do sol, presença não liga mais
    - Desliga por ausência (se existir sensor)
  domain: automation

  input:

    luzes:
      name: Luz(es) ou Switch(es)
      selector:
        target:
          entity:
            domain: [light, switch]

    sensor_presenca:
      name: Sensor de presença (opcional)
      default: ""
      selector:
        entity:
          domain: binary_sensor

    sensor_lux:
      name: Sensor de luminosidade (opcional)
      default: ""
      selector:
        entity:
          domain: sensor

    limite_lux:
      name: Limiar de luminosidade para ligar (opcional)
      default: 20
      selector:
        number:
          min: 0
          max: 5000
          mode: box

    usar_lux_no_horario:
      name: Usar luminosidade no horário principal?
      default: false
      selector:
        boolean:

    tempo_ausencia:
      name: Tempo sem presença para desligar (se houver sensor)
      selector:
        number:
          min: 1
          max: 3600
          unit_of_measurement: seconds
      default: 180

    horario_inicio:
      name: Horário para ligar
      default: "18:00:00"
      selector:
        time:

    horario_fim:
      name: Horário para desligar
      default: "00:00:00"
      selector:
        time:

trigger:

  # Presença detectada (somente se houver sensor)
  - platform: state
    entity_id: !input sensor_presenca
    to: "on"

  # Ausência pelo tempo configurado (somente se houver sensor)
  - platform: state
    entity_id: !input sensor_presenca
    to: "off"
    for:
      seconds: !input tempo_ausencia

  # Horário de ligar
  - platform: time
    at: !input horario_inicio

  # Horário de desligar
  - platform: time
    at: !input horario_fim

variables:
  sensor_presenca: !input sensor_presenca
  sensor_lux: !input sensor_lux
  usar_lux: !input usar_lux_no_horario
  limite_lux: !input limite_lux

action:
  - choose:

      ###################################################################
      # 1 — LIGAR NO HORÁRIO (com luminosidade opcional)
      ###################################################################
      - conditions:
          - condition: template
            value_template: >
              {{ not usar_lux or
                 (sensor_lux != "" and (states(sensor_lux) | float(9999) < limite_lux)) }}
        sequence:
          - service: homeassistant.turn_on
            target: !input luzes

      ###################################################################
      # 2 — DESLIGAR NO HORÁRIO FINAL
      ###################################################################
      - conditions:
          # Nenhuma condição necessária porque o trigger já é horário exato
          # Pode remover condição time com 'at'
          # Se quiser, pode deixar vazio ou só 'true'
          - condition: template
            value_template: "true"
        sequence:
          - service: homeassistant.turn_off
            target: !input luzes

      ###################################################################
      # 3 — LIGAR POR PRESENÇA FORA DO HORÁRIO (somente se houver sensor)
      ###################################################################
      - conditions:
          - condition: template
            value_template: "{{ sensor_presenca != '' }}"
          - condition: state
            entity_id: !input sensor_presenca
            state: "on"
          - condition: sun
            after: sunrise
            before: sunset
          - condition: template
            value_template: >
              {% set inicio = (inputs.horario_inicio | string) %}
              {% set fim = (inputs.horario_fim | string) %}
              {{ not (inicio <= now().strftime('%H:%M:%S') <= fim) }}
        sequence:
          - service: homeassistant.turn_on
            target: !input luzes

      ###################################################################
      # 4 — DESLIGAR POR AUSÊNCIA (somente se houver sensor)
      ###################################################################
      - conditions:
          - condition: template
            value_template: "{{ sensor_presenca != '' }}"
          - condition: state
            entity_id: !input sensor_presenca
            state: "off"
          - condition: state
            entity_id: !input luzes
            state: "on"
        sequence:
          - service: homeassistant.turn_off
            target: !input luzes
